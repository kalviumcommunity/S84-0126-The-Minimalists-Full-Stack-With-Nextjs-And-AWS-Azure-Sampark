name: CI/CD Pipeline - Multi-Environment Deployment

on:
  push:
    branches:
      - main        # Deploy to production
      - staging     # Deploy to staging
      - develop     # Run tests only
  pull_request:
    branches:
      - main
      - staging

env:
  NODE_VERSION: '20.x'

jobs:
  # ============================================
  # JOB 1: Lint & Test
  # ============================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sampark/package-lock.json

      - name: Install dependencies
        working-directory: ./sampark
        run: npm ci

      - name: Run ESLint
        working-directory: ./sampark
        run: npm run lint

      - name: Run tests
        working-directory: ./sampark
        run: npm test

  # ============================================
  # JOB 2: Build & Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.sampark.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sampark/package-lock.json

      - name: Install dependencies
        working-directory: ./sampark
        run: npm ci

      # Create .env.staging with secrets from GitHub Secrets
      - name: Create staging environment file
        working-directory: ./sampark
        run: |
          cat > .env.staging << EOF
          NODE_ENV=staging
          PORT=3000
          VITE_API_URL=${{ secrets.STAGING_API_URL }}
          DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
          REDIS_URL=${{ secrets.STAGING_REDIS_URL }}
          UPSTASH_REDIS_REST_URL=${{ secrets.STAGING_UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN=${{ secrets.STAGING_UPSTASH_REDIS_REST_TOKEN }}
          JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
          SESSION_SECRET=${{ secrets.STAGING_SESSION_SECRET }}
          JWT_EXPIRATION=7d
          REFRESH_TOKEN_EXPIRATION=30d
          CLOUDINARY_CLOUD_NAME=${{ secrets.STAGING_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.STAGING_CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.STAGING_CLOUDINARY_API_SECRET }}
          GOOGLE_AI_API_KEY=${{ secrets.STAGING_GOOGLE_AI_API_KEY }}
          ALLOWED_ORIGINS=${{ secrets.STAGING_ALLOWED_ORIGINS }}
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          LOG_LEVEL=info
          ENABLE_QUERY_LOGGING=false
          EOF

      - name: Build staging application
        working-directory: ./sampark
        run: npm run build:staging

      - name: Configure AWS credentials (for AWS deployment)
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (Staging)
        working-directory: ./sampark
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/sampark:staging .
          docker push ${{ secrets.DOCKER_USERNAME }}/sampark:staging

      # Add your deployment steps here (AWS ECS, Azure Web App, etc.)
      - name: Deploy to staging environment
        run: echo "Deploy to staging server - Add your deployment commands here"

  # ============================================
  # JOB 3: Build & Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://sampark.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sampark/package-lock.json

      - name: Install dependencies
        working-directory: ./sampark
        run: npm ci

      # Create .env.production with secrets from GitHub Secrets
      - name: Create production environment file
        working-directory: ./sampark
        run: |
          cat > .env.production << EOF
          NODE_ENV=production
          PORT=3000
          VITE_API_URL=${{ secrets.PRODUCTION_API_URL }}
          DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}
          REDIS_URL=${{ secrets.PRODUCTION_REDIS_URL }}
          UPSTASH_REDIS_REST_URL=${{ secrets.PRODUCTION_UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN=${{ secrets.PRODUCTION_UPSTASH_REDIS_REST_TOKEN }}
          JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }}
          SESSION_SECRET=${{ secrets.PRODUCTION_SESSION_SECRET }}
          JWT_EXPIRATION=7d
          REFRESH_TOKEN_EXPIRATION=30d
          CLOUDINARY_CLOUD_NAME=${{ secrets.PRODUCTION_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.PRODUCTION_CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.PRODUCTION_CLOUDINARY_API_SECRET }}
          GOOGLE_AI_API_KEY=${{ secrets.PRODUCTION_GOOGLE_AI_API_KEY }}
          ALLOWED_ORIGINS=${{ secrets.PRODUCTION_ALLOWED_ORIGINS }}
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=50
          LOG_LEVEL=error
          ENABLE_QUERY_LOGGING=false
          EOF

      - name: Build production application
        working-directory: ./sampark
        run: npm run build:production

      - name: Configure AWS credentials (for AWS deployment)
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (Production)
        working-directory: ./sampark
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/sampark:latest .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/sampark:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/sampark:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/sampark:${{ github.sha }}

      # Add your deployment steps here (AWS ECS, Azure Web App, etc.)
      - name: Deploy to production environment
        run: echo "Deploy to production server - Add your deployment commands here"

      - name: Notify deployment success
        run: echo "âœ… Production deployment completed successfully!"
